# Information gathering
## 들어가며
블랙박스 환경에서는 대상 Ip 등의 제한된 정보만으로 해당 시스템의 취약점을 점검해야 한다. 때문에 제한 정보들을 테스터 본인의 역량으로 계속해서 확장해 나가는 것이 매우 중요하다. 획득한 정보를 가지고 분석하여 취약점을 찾아내는 것도 침투 테스터의 중요한 자질임은 분명하지만 침투 과정에서 계속해서 정보들을 수집(information gathering)하고 열거(enumeration)해나가는 실력이 먼저 확보되어야 한다. 이번 장에서는 해당 지식들에 대해 부분적으로 다룰 것이다. 나머지에 대한 부분은 다른 파트들과 함께 습득하도록 할 것이다.

## 목차 
- Active & Passive Information gathering
- port scanning

## Active & Passive Information gathering
Information gathering은 늗동과 수동 이렇게 크게 두가지로 분류할 수 있다. 분류의 기준은 대상 시스템에 직접적으로 접근했는가 여부를 따진다. 예를 들어 구글링을 통해 해당 서버의 정보를 알아냈다면 해당 서버에 직접적인 접근 없이 구글을 통해 정보를 수집한 것이므로 수동적 정보 수집으로 분류한다. 반면 대상 서버의 포트를 nmap등의 도구를 통해 스캐닝했다면 이는 대상 서버에 직접적으로 접근했기 때문에 능동적 정보 수집으로 분류한다. 수동적 정보 수집은 분량상 생략하고 바로 능동적 정보 수집을 다루겠다.

## Port Scanning

능동적 정보 수집에 핵심이 되는 것은 바로 port scanning이다. 우리는 해당 서버의 어떤 포트가 열려 있고 어떤 네트워크 서비스가 제공되고 있는지를 포트 스캐닝을 통해 파악할 것이다. 거기에 대하여 추가적인 정보를 수집하는 것까지 해당 파트에서 다루도록 하겠다.

### 원래는 ...
블랙박스 환경에서는 대상 Ip가 특정되지 않고 네트워크만 알게 될 때도 있다. 때문에 해당 네트워크에 속한 모든 주소를 스캐닝하여 각 Ip 주소에 해당하는 서버가 있는지를 먼저 파악해야 한다. 그러나 우리가 실습할 HackTheBox는 하나의 Ip 주소를 고정하기 때문에 이러한 내용들은 생략하고 로컬에서 접속할 수 있는 Ip 주소를 알고 있다고 가정하고 진행하도록 하겠다. (가끔 난이도가 높은 문제에서 컨테이너 환경을 구축하고 그 안 네트워크 탐색을 해야 하는 상황이 연출된다.)

### nmap 

nmap은 포트 스캐닝 중 도구 중 하나로서 가장 많이 쓰이고 동시에 기본이 되는 스캐닝 도구이다. nmap 사용법을 단순히 이해하는 것을 넘어 포트 스캐닝에 대한 과정을 함께 이해함으로 다른 최신 도구를 이용할 때에도 익숙하게 사용할 수 있도록 하는 것이 목표이다.

```bash
nmap [target address]
```

위와 같이 간단히 타겟에 대해 1000개의 포트에 대해 포트 스캐닝을 진행할 수 있다. 여기서 포트 스캐닝의 모드가 있다는 것에 주목할 필요가 있다. 

1. 스텔스 모드 (-sS)
스텔스 모드는 tcp 포트 스캐닝 방식 중 하나로 syn 패킷만을 보내고 타겟의 반응에 따라 포트의 상태를 결정하는 방식이다. tcp 연결을 완료하지 않고 스캐닝하기 때문에 빠르고 상대방 입장에서는 연결이 되지 않았기 때문에 로그가 남지 않아(일반적으로) 이 모드를 스텔스라고 하는 것이다. 다만 이 모드의 경우 raw packet 권한을 필요로 하기 때문에 sudo나 root 권한이 있어야 사용 가능하다. 우리는 로컬에서 포트 스캐닝을 진행할 것이기 때문에 거의 대부분 이 모드를 사용할 것이다. 

2. TCP connected 모드 (-sT)
아무런 옵션이 기재되지 않았을 때 사용되는 기본 모드이다. raw packet이 아닌 os의 system call을 통해 연결을 한다. 때문에 많은 패킷을 요하며 느리고 로그가 기록될 가능성이 높다. 따라서 일반적으로는 관리자 권한이 있는 경우에 스텔스모드를 사용하지만 **proxy를 통해 스캔할 때는 해당 모드를 사용한다.**

3. udp scan 모드 (-sU)
udp 포트 스캐닝을 진행하는 모드로 raw packet 권한을 필요로 한다. udp 특성상 응답 패킷을 받아 open으로 판명되면 문제가 없지만 응답이 없는 경우 정말로 포트가 닫혀 있는 것인지 아니면 열려 있으나 서버 자체 설정으로 응답 패킷을 보내지 않은 것인지 알 수 없다. 이로 인해 udp 포트 스캐닝을 느리고 신뢰도 낮다. tcp 모드와 함께 사용할 수 있다.


스캐닝 방식은 위의 3가지로 요약할 수 있다만 그 외에 유용한 정보를 제공하는 옵션도 알아둘 필요가 있다.

- 버젼 정보 감지 (-sV)
nmap이 프로토콜을 인식하고 자체 db에 있는 정보와 대조함으로 열려 있는 포트가 어떤 프로토콜을 사용하고 어떤 서비스인지 구체적으로 알려주는 옵션이다. 다만 서버 세팅에 따라 해당 정보는 주어지지 않을 수 있고 정확하지 않을 수 있다. 그런 경우 ?가 함께 붙는다.

- 운영체제 정보 감지 (-O)
타겟의 운영체제에 대한 탐지를 하는 옵션 --os-guess와 함께 사용하면 pecfect matching이 아니여도 nmap이 추측해서 결과를 보여준다. 

- 기본 스크립트 사용 (-sC)
NSE (Nmap Script Engine)은 각 서비스에 대한 여러가지 기능성 스크립트들을 활용하게 해주는데 sC는 해당 서비스를 능동적으로 탐지하여 디폴트인 스크립트들을 사용해 그 결과를 보여주는 옵션이다.

지금까지 포트 nmap의 모드와 추가적인 정보를 제공하는 유용한 옵션들에 대해 알아 보았다. 그렇다면 실전에선 어떤 방식으로 nmap을 사용해야 할까? 특이사항이 없는 타겟의 경우, 필자는 여러번의 포트 스캐닝 경험을 통해 해당 순서가 합리적임을 느끼고 아래와 같이 정립하게 되었다.

1. udp 161 포트에 대해 포트 스캐닝한다. 
```bash
sudo nmap -sU -sV -p 161 
```

udp 포트 스캐닝은 이론상 오래걸리고 또 신뢰도도 낮다. 그리고 udp로 서비스되는 네트워크 서비스는 많지 않다. 이러한 특성 때문에 출제되는 머신은 항상 udp 161 snmp에서 출제되었다. (snmp인 까닭은 나중에 다루도록 하겠다) 100중 99는 udp와 아무 상관이 없는 문제들이지만 백의 하나가 걸린 경우 tcp를 다뒤져도 단서를 찾지 못해 기진맥진한 상태가 되기 싶상이다. 때문에 이를 방지하고자 161을 먼저 스캐닝하자.


2. 1000개의 포트에 대해 tcp 스캐닝한다.
```bash
sudo nmap -sS -sV -sC 
```
sV와 sC를 함께 활용하여 추가적인 정보를 꼭 함께 챙기도록 하자.

3. 다른 작업들을 하며 or 1000개의 포트 스캐닝 결과가 유용하지 않다고 판단되면 전체 포트 스캐닝을 진행한다. (T5도 빠르기 때문에 좋은 선택일 수 있지만 정확도가 낮아진다.)
```
sudo nmap -sS -p- -T4
```

필자가 굉장히 싫어하는 절차지만 생각보다 빈번히 출제되는 요소 중 하나인 전체 포트 스캐닝이다. 무려 65535개의 포트를 전부 스캐닝하기 때문에 시간이 매우 오래 걸리며 네트워크 환경에 따라 예상소요 시간이 무한이 갱신될 수도 있다. 그럼에도 불구하고 일반적이지 않은 포트가 열려 있는 것은 문제를 푸는데 매우 중요한 역할을 하는 경우가 많았기 때문에 1000개의 포트로도 해답을 찾지 못한 경우 충분히 시도해볼 만한 과정이다.

지금까지 포트 스캐닝하는 과정에 대해 알아보았다. 지금부터는 포트 스캐닝을 통해 발견될 각각의 네트워크 서비스에 대해 어떻게 정보를 열거하는지 알아보도록 하겠다. 다만 80,443 (http, https)의 경우 열거할 정보와 경우의 수가 많기 때문에 따로 다루도록 하겠다.

### 과제 
다음 머신들의 open된 포트와 네트워크 서비스를 모두 알아내시오 (개별)

- Broker.htb 
- Sau.htb
- Pandora.htb