# Linux Privilege Escalation 
## 개요
지금까지 우리는 여러 취약점을 이용하여 일반 사용자의 쉘을 획득하는 과정을 학습하였다. 본 챕터에서는 일반 사용자 권한에서 root 권한을 획득하는 권한 상승에 대해 학습할 것이다. 

## Linux Enumeration(Manual) 
우리가 웹에서 우리가 수집할 수 있는 정보를 enumeration하여 쉘 획득으로 연결하였듯 쉘을 획득한 상황에서 권한 상승을 하기 위해 정보를 수집할 것이다. 물론 linpeas와 같은 자동화 도구를 사용하면 간편하게 수집할 수 있으나 자동화 도구에만 의존하는 것은 반쪽짜리 해커가 하는 짓이다. 우리는 수동으로 정보를 수집하는 방법을 먼저 알아보겠다.

### user & group
현재 사용자의 uid, gid, groups, sudo 권한으로 실행가능한 명령어를 파악한다. 이 중에서 본인이 모르는 단어나 부분이 있다면 공부하자

1. id ; cat /etc/passwd : user enum
2. sudo -l : 본인의 sudo 권한 확인(대부분 비밀번호가 필요함)

루트가 아닌 다른 사용자를 파악하는 것은 매우 중요하다. 왜냐하면 현재 사용자 쉘로는 권한 상승이 불가하나 다른 일반 사용자에 존재하는 취약점으로 권한 상승이 가능한 경우가 많기 때문이다. 다시 말해 lateral movement를 하기 위해서라도 다른 사용자 정보를 잘 열거할 필요가 있는 것이다. 

### system 
1. hostname : 시스템 이름 확인
2. cat /etc/issue; cat /etc/os-release; uname -a : os version 및 kernel version
3. lsmod; /sbin/modinfo [module name]: 로드된 커널 모듈과 구체적인 모듈 정보

해당 정보는 커널 익스플로잇을 사용하려면 필요한 정보이다. 커널 익스플로잇이 유효한 경우 곧바로 권한상승으로 이어지기 때문에 주의 깊게 봐야할 정보이다. 


### aplication & process
1. ps aux or watch -n 1 "ps -aux" (pspy를 사용하자): 현재 실행되고 있는 프로세스에 대한 정보
    - 직접적으로 권한 상승에 도움이 되는 케이스 : cmdline에 비밀번호가 입력된 경우, 
    - 새로운 enumeration이 필요한 케이스 : db, 이전에 접근할 수 없었던 webserver 등
2. ls -lah /etc/cron* : 모든 예약된 작업 확인
3. grep "CRON" /var/log/syslog : log 파일에서 크론 작업 내역 확인
    - 보통 syslog를 권한 문제로 읽을 수 없을 것이다. 
3. dpkg -l: 설치된 어플리케이션과 버젼 확인

현재 실행되고 있는 프로세스는 3가지의 경우로 권한 상승과 연관이 있다. 

1. 인자에 비밀번호 등의 정보를 기입하여 누출되는 경우
2. root 등의 권한이 있는 사용자의 프로세스가 취약점을 가지고 있는 경우
3. 흔치 않은 포트를 오픈한 서비스에 대한 정체 파악

### network
loopback에서만 가능한 서비스를 탐색하는 것은 공격 표면을 넓히는 좋은 행동이다. 또한 컨테이너에서 쉘이 획득된 경우 다른 컨테이너의 ip를 식별하는 것도 중요하다. 
1. ip a (ifconfig) : 모든 인터페이스 출력
2. route or routel : route table 출력
3. ss -anp (natstat) : active network service와 포트 출력
4. sudo tcpdump -i [인터페이스] -A | grep "pass" : 패킷을 조사해서 pass라는 내용이 있는지 확인 (sudo 권한 필요)

### firewall
일반적으로 firewall rule을 보려면 root 권한이 필요하다 그러나 설정에 따라 다음과 같이 확인할 수 있는 방법이 있다.
- /etc/iptables 경로 아래 있는 save 파일을 찾아본다. (종종 일반 사용자도 읽을 수 있다.)

### file system 
1. **find / -writable -type d 2>/dev/null**
    이 자체로는 유익하지 않지만 다른 열거한 정보와 조합(서비스나 예약작업 등)했을 때 권한 상승을 도모할 수 있는 부분이 많다.
2. find / -perm -u=s -type f 2>/dev/null : set-uid 권한이 있는 파일을 출력한다.
3. cat /etc/fstab; mount : 부팅 시 마운트되는 드라이브와 마우트된 드라이브 출력
4. lsblk : 이용가능한 모든 디스크 표시
    마운트되지 않은 디스크 중에서 중요한 정보를 담고 있는 것이 있을 수 있다.

권한이 잘못 부여된 파일과 디렉토리는 권한 상승으로 이어지게 되는 경우가 많다. 

### enumerate for plain text 

1. env : 환경 변수에 중요한 정보가 있는지 확인한다.
2. cat .bashrc : 쉘이 열릴 때 실행되는 스크립트로 중요한 정보가 있는지 확인한다.
3. 


## Auto
많은 자동화 도구 중에서 /usr/share/peass/linpeas/linpeas.sh를 사용할 것이다. tool과 같은 디렉토리에 복사해두고 타켓서버에 전송(httpservert -> wget)하여 해당 서버에서 실행하면 된다. 

## 과제
권한 상승은 web과는 다르게 어느정도의 실전 경험이 누적되어야 스스로 할 수 있기 때문에 함께 실습한 내용을 복습 정리하는 것을 과제로 하겠다. 